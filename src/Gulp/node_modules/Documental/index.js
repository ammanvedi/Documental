
var Documental = (function(){

    var Utils = {};
    var total = 0;
    var currentFunctionBoundaries = 0;
    var par;

    Utils.postOrderTraverse = function(node)
    {

        if(node.name)
        {
            return node.name;
        }else{
            if(node.type == 'ThisExpression')
            {
                return "this";
            }else if(node.type == "Literal"){
                return "[ LITERAL ]";
            }else
            {
                return Utils.postOrderTraverse(node.object) + "."  + Utils.postOrderTraverse(node.property);
            }

        }
    }

    Utils.determineFunctions = function(sourceString, acornInstance, walk)
    {
        var methodCount = 0;
        currentFunctionBoundaries = 0;
        var nested = "";

        var ast = acornInstance.parse(sourceString, {
            locations: true,
            ranges: true,
            directSourceFile: true
        });

        walk(ast, function(node){

            // detect functions declared at runtime
            if(node.type == 'FunctionDeclaration')
            {

                nested = Utils.determineNesting(node.loc);
                par = Utils.paramsToStringRepresentation(Utils.getSimpleParameters(node));
                methodCount++;

                console.log("Method Declared : ", nested,node.id.name, par);
            }
            // detect functions declared as variables
            if(node.type == 'VariableDeclaration')
            {
                node.declarations.forEach(function(declaration, declIndex){
                    if( declaration.init && declaration.init.type == 'FunctionExpression')
                    {
                        nested = Utils.determineNesting(declaration.loc);
                        par = Utils.paramsToStringRepresentation(Utils.getSimpleParameters(declaration.init));
                        methodCount++;

                        console.log("Method Declared : ", nested,declaration.id.name, par);
                    }
                })
            }

            //detect functions created on prototypes and
            if(node.type == 'ExpressionStatement')
            {
                if(node.expression && node.expression.left && node.expression.right && node.expression.left.type == 'MemberExpression'
                    &&  node.expression.right.type == 'FunctionExpression')
                {

                    nested = Utils.determineNesting(node.expression.right.loc);
                    par = Utils.paramsToStringRepresentation(Utils.getSimpleParameters(node.expression.right));
                    methodCount++;

                    console.log("Method Declared : ", nested ,Utils.postOrderTraverse(node.expression.left), par );
                }
            }

        });

        console.log("\n\nDetected "  + methodCount + " methods in total...\n\n");
        total += methodCount;

    }

    Utils.determineNesting = function(location)
    {
        if(currentFunctionBoundaries)
        {
            if(location.start.line > currentFunctionBoundaries.end.line)
            {
                currentFunctionBoundaries = location;
                return "";
            }else if (location.start.line < currentFunctionBoundaries.end.line)
            {
                return "      ";
            }

        }else{
            currentFunctionBoundaries = location;
            return "";
        }
    }


    Utils.getTotal = function()
    {
        return total;
    }

    Utils.getSimpleParameters = function(functionStructure)
    {
        var params = [];
        functionStructure.params.forEach(function(p){
            params.push(p.name);
        });
        return params;

    }

    Utils.paramsToStringRepresentation = function(p)
    {
        if(p.length > 0)
        {
            return " <-- " + p.join(" | ");
        }else{
            return "";
        }
    }

    return {
        UTIL : Utils
    }


})();


module.exports = Documental;